# –û—Ç—á–µ—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ DialogService - –≠—Ç–∞–ø 1

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å `PromptBuilderService`
- **–§–∞–π–ª**: `app/services/prompt_builder_service.py` (272 —Å—Ç—Ä–æ–∫–∏)
- **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å**: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- **–ú–µ—Ç–æ–¥—ã**:
  - `build_classification_prompt()` - –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç–∞–¥–∏–π
  - `build_generation_prompt()` - –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
  - `build_fallback_prompt()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è fallback —Ä–µ–∂–∏–º–∞
  - `build_full_history_with_system_prompt()` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `ClassificationService`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `PromptBuilderService`
- –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `PromptBuilderService`
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 131 ‚Üí 133 —Å—Ç—Ä–æ–∫–∏ (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)

### ‚úÖ –£–ø—Ä–æ—â–µ–Ω `DialogService`
- **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞**: 805 ‚Üí 658 —Å—Ç—Ä–æ–∫ (**-147 —Å—Ç—Ä–æ–∫, -18%**)
- –£–¥–∞–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
  - `_build_dynamic_system_prompt()` (90 —Å—Ç—Ä–æ–∫)
  - `_build_fallback_system_prompt()` (20 —Å—Ç—Ä–æ–∫)
  - `_build_full_history_with_system_prompt()` (30 —Å—Ç—Ä–æ–∫)
- –î–æ–±–∞–≤–ª–µ–Ω –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `_build_dialog_context()` –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –í—Å—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ –≤—ã–∑–æ–≤—ã `PromptBuilderService`

## –ü—Ä–∏–Ω—Ü–∏–ø—ã SOLID

### ‚úÖ Single Responsibility Principle (SRP)
- **–î–æ**: `DialogService` –æ—Ç–≤–µ—á–∞–ª –∑–∞ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é + —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- **–ü–æ—Å–ª–µ**: 
  - `DialogService` - —Ç–æ–ª—å–∫–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
  - `PromptBuilderService` - —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
  - `ClassificationService` - —Ç–æ–ª—å–∫–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞–¥–∏–π

### ‚úÖ Open/Closed Principle (OCP)
- `PromptBuilderService` –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ —Ç–∏–ø–∞–º–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö

### ‚úÖ Dependency Inversion Principle (DIP)
- `DialogService` —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ (`PromptBuilderService`)
- `ClassificationService` —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptBuilderService`

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
- **DialogService**: 805 ‚Üí 658 —Å—Ç—Ä–æ–∫ (-147 —Å—Ç—Ä–æ–∫, -18%)
- **–ù–æ–≤—ã–π PromptBuilderService**: 272 —Å—Ç—Ä–æ–∫–∏
- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫**: +125 —Å—Ç—Ä–æ–∫ (–Ω–æ —Å –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)

### üéØ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: `DialogService` —Å—Ç–∞–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —á–∏—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: `PromptBuilderService` –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
3. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
4. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –ø—Ä–æ–º–ø—Ç–æ–≤

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- API `DialogService` –æ—Å—Ç–∞–ª—Å—è –ø—Ä–µ–∂–Ω–∏–º
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–≠—Ç–∞–ø 2**: –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É Function Calling –≤ `FunctionCallOrchestrator`
2. **–≠—Ç–∞–ø 3**: –°–æ–∑–¥–∞—Ç—å `ClientContextService` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–∞
3. **–≠—Ç–∞–ø 4**: –°–æ–∑–¥–∞—Ç—å `DialogMemoryService` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω. `DialogService` —Å—Ç–∞–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —á–∏—â–µ –∏ –ª–µ–≥—á–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è. –ü—Ä–∏–Ω—Ü–∏–ø –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–ø–µ—Ä—å —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è - –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ä–æ–ª—å.
