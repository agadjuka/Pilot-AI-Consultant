# –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢: –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–´ –° –ó–ê–ü–ò–°–Ø–ú–ò

## üìã –û–ë–ó–û–† –°–ò–°–¢–ï–ú–´

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø–∏—Å—è–º–∏ –≤ AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–µ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–∏–∞–ª–æ–≥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM (Google Gemini/YandexGPT) –∏ —Ñ—É–Ω–∫—Ü–∏–∏ Function Calling. –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å YDB (Yandex Database).

---

## üéØ –ö–û–ú–ê–ù–î–´ –†–ê–ë–û–¢–´ –° –ó–ê–ü–ò–°–Ø–ú–ò

### 1. üìù **–°–û–ó–î–ê–ù–ò–ï –ó–ê–ü–ò–°–ò** (`booking_confirmation`)

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `booking_confirmation`  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `create_appointment(master_name: str, service_name: str, date: str, time: str, client_name: str)`
- `save_client_name(name: str)`
- `save_client_phone(phone: str)`

#### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è** (`tool_orchestrator_service.py:713-719`)
   ```python
   elif function_name == "create_appointment":
       master_name = function_args.get("master_name", "")
       service_name = function_args.get("service_name", "")
       date = function_args.get("date", "")
       time = function_args.get("time", "")
       client_name = function_args.get("client_name", "")
       return method(master_name, service_name, date, time, client_name, user_id)
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService** (`tool_service.py:173-200`)
   ```python
   def create_appointment(self, master_name: str, service_name: str, date: str, time: str, client_name: str, user_telegram_id: int) -> str:
       # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
       parsed_date = parse_date_robust(date)
       
       # –í—ã–∑–æ–≤ AppointmentService
       return self.appointment_service.create_appointment(
           master_name=master_name,
           service_name=service_name,
           date=parsed_date,
           time=time,
           client_name=client_name,
           user_telegram_id=user_telegram_id
       )
   ```

3. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ AppointmentService** (`appointment_service.py:59-196`)

   **–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è:**
   - **–ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–∞:** `master_repository.get_by_name(master_name)`
   - **–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:** `service_repository.get_by_name(service_name)`
   - **–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞:** `client_repository.get_by_telegram_id(user_telegram_id)`
   - **–ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏:** `datetime.strptime(time, "%H:%M")`
   - **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** `start_datetime + timedelta(minutes=duration_minutes)`
   - **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.create_event()`

4. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ DBCalendarService** (`db_calendar_service.py:42-85`)
   ```python
   def create_event(self, master_id: int, service_id: int, user_telegram_id: int, start_time: datetime, end_time: datetime, description: str) -> int:
       # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
       appointment_data = {
           'master_id': master_id,
           'service_id': service_id,
           'user_telegram_id': user_telegram_id,
           'start_time': start_time_iso,
           'end_time': end_time_iso,
           'description': description
       }
       
       appointment_id = self.appointment_repository.create(appointment_data)
       return appointment_id
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

---

### 2. üëÄ **–ü–†–û–°–ú–û–¢–† –ó–ê–ü–ò–°–ï–ô** (`view_booking`)

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `view_booking`  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()`

#### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è** (`tool_orchestrator_service.py:721-722`)
   ```python
   elif function_name == "get_my_appointments":
       return method(user_id)
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService** (`tool_service.py:224-241`)
   ```python
   def get_my_appointments(self, user_telegram_id: int) -> str:
       appointments = self.appointment_service.get_my_appointments(user_telegram_id)
       return self._format_appointments_for_llm(appointments)
   ```

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ AppointmentService** (`appointment_service.py:197-252`)
   ```python
   def get_my_appointments(self, user_telegram_id: int) -> list:
       # –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
       appointments = self.appointment_repository.get_by_user_telegram_id(user_telegram_id)
       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –∫–ª–∏–µ–Ω—Ç–∞

---

### 3. üóëÔ∏è **–û–¢–ú–ï–ù–ê –ó–ê–ü–ò–°–ò** (`cancellation_request`)

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `cancellation_request`  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()` (thinking)
- `cancel_appointment_by_id(appointment_id: int)` (synthesis)

#### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è** (`tool_orchestrator_service.py:724-732`)
   ```python
   elif function_name == "cancel_appointment_by_id":
       appointment_id = function_args.get("appointment_id") or function_args.get("id", 0)
       try:
           appointment_id = int(appointment_id)
       except (ValueError, TypeError):
           return "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∑–∞–ø–∏—Å–∏"
       return method(appointment_id, user_id)
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService** (`tool_service.py:253-294`)
   ```python
   def cancel_appointment_by_id(self, appointment_id: int, user_telegram_id: int) -> str:
       return self.appointment_service.cancel_appointment_by_id(appointment_id, user_telegram_id)
   ```

3. **–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –≤ AppointmentService** (`appointment_service.py:253-308`)

   **–ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ç–º–µ–Ω—ã:**
   - **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:** `appointment['user_telegram_id'] != user_telegram_id`
   - **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏:**
     - –ú–∞—Å—Ç–µ—Ä: `master_repository.get_by_id(appointment['master_id'])`
     - –£—Å–ª—É–≥–∞: `service_repository.get_by_id(appointment['service_id'])`
   - **–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.delete_event(appointment_id)`

4. **–£–¥–∞–ª–µ–Ω–∏–µ –≤ DBCalendarService** (`db_calendar_service.py:87-150`)
   ```python
   def delete_event(self, appointment_id: int) -> None:
       # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
       self.appointment_repository.delete(appointment_id)
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏

---

### 4. üìÖ **–ü–ï–†–ï–ù–û–° –ó–ê–ü–ò–°–ò** (`rescheduling`)

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `rescheduling`  
**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()` (thinking)
- `get_available_slots(service_name: str, date: str)` (thinking)
- `reschedule_appointment_by_id(appointment_id: int, new_date: str, new_time: str)` (synthesis)

#### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è** (`tool_orchestrator_service.py:734-744`)
   ```python
   elif function_name == "reschedule_appointment_by_id":
       appointment_id = function_args.get("appointment_id") or function_args.get("id", 0)
       new_date = function_args.get("new_date", "")
       new_time = function_args.get("new_time", "")
       try:
           appointment_id = int(appointment_id)
       except (ValueError, TypeError):
           return "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∑–∞–ø–∏—Å–∏"
       return method(appointment_id, new_date, new_time, user_id)
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService** (`tool_service.py:295-318`)
   ```python
   def reschedule_appointment_by_id(self, appointment_id: int, new_date: str, new_time: str, user_telegram_id: int) -> str:
       # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
       parsed_date = parse_date_robust(new_date)
       
       return self.appointment_service.reschedule_appointment_by_id(
           appointment_id=appointment_id,
           new_date=parsed_date,
           new_time=new_time,
           user_telegram_id=user_telegram_id
       )
   ```

3. **–ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏ –≤ AppointmentService** (`appointment_service.py:309-552`)

   **–ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–Ω–æ—Å–∞:**
   - **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:** `appointment['user_telegram_id'] != user_telegram_id`
   - **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏:**
     - –ú–∞—Å—Ç–µ—Ä: `master_repository.get_by_id(appointment['master_id'])`
     - –£—Å–ª—É–≥–∞: `service_repository.get_by_id(appointment['service_id'])`
   - **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥–∏:** `service['duration_minutes']`
   - **–ü–∞—Ä—Å–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:** `datetime.strptime(new_time, "%H:%M")`
   - **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** `start_datetime + timedelta(minutes=duration_minutes)`
   - **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.update_event()`

4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ DBCalendarService** (`db_calendar_service.py:111-145`)
   ```python
   def update_event(self, appointment_id: int, new_start_time: datetime, new_end_time: datetime) -> None:
       # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
       update_data = {
           'start_time': new_start_time_iso,
           'end_time': new_end_time_iso
       }
       
       # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
       self.appointment_repository.update(appointment_id, update_data)
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–∏

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```
tool_orchestrator_service ‚Üí tool_service ‚Üí appointment_service ‚Üí db_calendar_service ‚Üí repositories ‚Üí YDB
```

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:
- **Read-only tools:** `get_all_services`, `get_masters_for_service`, `get_available_slots`, `get_my_appointments`
- **Write tools:** `create_appointment`, `cancel_appointment_by_id`, `reschedule_appointment_by_id`

### –°—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞:
- **Thinking stage:** –í—ã–∑–æ–≤ read-only –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- **Synthesis stage:** –í—ã–∑–æ–≤ write –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üóÑÔ∏è –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° YDB

### ‚úÖ **–ü–û–õ–ù–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨ –ö YDB**

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å YDB:

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YDB** (`app/core/database.py`)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —á–∏—Å—Ç—ã–π –¥—Ä–∞–π–≤–µ—Ä YDB
   - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Service Account
   - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—É–ª —Å–µ—Å—Å–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

2. **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** (`app/repositories/`)
   - –í—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseRepository`
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç YDB-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: `execute_query`, `upsert_record`, `delete_record`
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü –≤ YDB:**
   - `services` - –£—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞
   - `masters` - –ú–∞—Å—Ç–µ—Ä–∞
   - `clients` - –ö–ª–∏–µ–Ω—Ç—ã
   - `master_services` - –°–≤—è–∑—å –º–∞—Å—Ç–µ—Ä–æ–≤ –∏ —É—Å–ª—É–≥
   - `appointments` - –ó–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥–∏
   - `dialog_history` - –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
   - `master_schedules` - –ì—Ä–∞—Ñ–∏–∫–∏ —Ä–∞–±–æ—Ç—ã –º–∞—Å—Ç–µ—Ä–æ–≤

4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`app/core/config.py`)
   ```python
   YDB_ENDPOINT: str = "grpcs://ydb.serverless.yandexcloud.net:2135"
   YDB_DATABASE: str = "/ru-central1/b1gxxxxxxxxxxxxxxxx/etnxxxxxxxxxxxxxxxx"
   ```

### üîß **–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å YDB:**

- `execute_query()` - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SELECT –∑–∞–ø—Ä–æ—Å–æ–≤
- `upsert_record()` - –í—Å—Ç–∞–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `delete_record()` - –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `execute_transaction()` - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `get_db_session()` - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–µ—Å—Å–∏–π

---

## üìä –î–ò–ê–õ–û–ì–û–í–´–ï –ü–ê–¢–¢–ï–†–ù–´

### –ò–∑ `dialogue_patterns.json`:

1. **`booking_confirmation`** - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
   - –¶–µ–ª—å: –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å, –∫–æ–≥–¥–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `create_appointment`, `save_client_name`, `save_client_phone`

2. **`view_booking`** - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π
   - –¶–µ–ª—å: –ü–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –µ–≥–æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `get_my_appointments`

3. **`cancellation_request`** - –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
   - –¶–µ–ª—å: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—Å—å–±—É –æ–± –æ—Ç–º–µ–Ω–µ, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞—á–∞–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `get_my_appointments`, `cancel_appointment_by_id`

4. **`rescheduling`** - –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏
   - –¶–µ–ª—å: –ü–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `get_my_appointments`, `get_available_slots`, `reschedule_appointment_by_id`

---

## üîÑ –ü–û–õ–ù–´–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–Ø

### 1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è** (`app/api/telegram.py`)
   ```python
   async def process_telegram_update(update: Update):
       # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram
       user_id = update.message.from_user.id
       text = update.message.text
       
       # –°–æ–∑–¥–∞–Ω–∏–µ DialogService
       dialog_service = DialogService()
       
       # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
       bot_response = await dialog_service.process_user_message(user_id, text)
   ```

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ DialogService** (`app/services/dialog_service.py`)
   ```python
   async def process_user_message(self, user_id: int, text: str) -> str:
       # –≠—Ç–∞–ø 1: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞
       stage = await self.classify_dialog_stage(history, text)
       
       # –≠—Ç–∞–ø 2: –ú—ã—à–ª–µ–Ω–∏–µ (—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö)
       if stage in ['availability_check', 'rescheduling']:
           thinking_result = await self.execute_thinking_stage(stage, history, text, user_id)
       
       # –≠—Ç–∞–ø 3: –°–∏–Ω—Ç–µ–∑ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)
       final_response = await self.execute_synthesis_stage(stage, history, text, user_id, thinking_result)
   ```

### 3. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤** (`app/services/tool_orchestrator_service.py`)
   ```python
   async def execute_tool_cycle(self, system_prompt: str, history: List[Dict], user_message: str, user_id: int):
       # –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ —Å LLM
       chat = self.llm_service.create_chat(full_history)
       
       # –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ Function Calling
       while iteration < max_iterations:
           # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM
           response_content = await self.llm_service.send_message_to_chat(chat, current_message, user_id)
           
           # –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
           if has_function_call:
               # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
               results = await asyncio.gather(*tasks, return_exceptions=True)
               
               # –ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ LLM
               current_message = combined_results + final_instruction
   ```

---

## ‚úÖ –°–¢–ê–¢–£–° –ì–û–¢–û–í–ù–û–°–¢–ò

### **–ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–û:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YDB
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### **–û–°–û–ë–ï–ù–ù–û–°–¢–ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò:**
- üîÑ –¢—Ä–µ—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–∞
- ‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üìù –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üîß –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞
- üéØ –£–º–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç–∞–¥–∏–π –¥–∏–∞–ª–æ–≥–∞

---

## üéâ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç—ã —Å –∑–∞–ø–∏—Å—è–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É. –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å YDB –∏ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YDB
- –ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
