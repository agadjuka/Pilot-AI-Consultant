# Архитектура "Менеджера Контекста"

## Обзор
Реализован "Менеджер Контекста" для отслеживания ключевых сущностей диалога и автоматического обогащения вызовов инструментов недостающими параметрами.

## Компоненты системы

### 1. DialogService
```
┌─────────────────────────────────────────────────────────────┐
│                    DialogService                           │
├─────────────────────────────────────────────────────────────┤
│ • dialog_contexts: Dict[user_id, context]                 │
│ • extract_and_save_entities()                               │
│ • process_user_message()                                    │
└─────────────────────────────────────────────────────────────┘
```

**Ключевые изменения:**
- Добавлен словарь `dialog_contexts` для хранения контекста каждого пользователя
- Метод `extract_and_save_entities()` извлекает сущности из tool_calls и сообщений
- Контекст передается в ToolOrchestratorService при выполнении инструментов

### 2. ToolOrchestratorService
```
┌─────────────────────────────────────────────────────────────┐
│                ToolOrchestratorService                      │
├─────────────────────────────────────────────────────────────┤
│ • enrich_tool_calls()                                       │
│ • execute_single_tool(dialog_context)                       │
│ • execute_tool_cycle(dialog_context)                        │
└─────────────────────────────────────────────────────────────┘
```

**Ключевые изменения:**
- Метод `enrich_tool_calls()` обогащает параметры из контекста
- Все методы выполнения инструментов принимают `dialog_context`
- Автоматическое добавление недостающих параметров

## Поток выполнения

### Этап 1: Извлечение сущностей
```
Пользователь: "Хочу записаться на маникюр на завтра"
    ↓
LLM планирование → tool_calls с параметрами
    ↓
extract_and_save_entities():
  - service_name: "маникюр" → dialog_context
  - date: "завтра" → dialog_context
```

### Этап 2: Обогащение инструментов
```
LLM: get_available_slots(service_name="", date="")
    ↓
enrich_tool_calls():
  - Добавляет service_name: "маникюр" из контекста
  - Добавляет date: "завтра" из контекста
    ↓
get_available_slots(service_name="маникюр", date="завтра")
```

## Поддерживаемые инструменты

### get_available_slots
- **Обогащается:** `service_name`, `date`
- **Логика:** Если параметр отсутствует, берется из контекста

### get_masters_for_service  
- **Обогащается:** `service_name`
- **Логика:** Если service_name пустой, используется из контекста

### create_appointment
- **Обогащается:** `service_name`, `master_name`, `date`
- **Логика:** Все параметры обогащаются из контекста при отсутствии

## Извлечение сущностей

### Из параметров инструментов
```python
for tool_call in tool_calls:
    params = tool_call.get('parameters', {})
    if 'service_name' in params and params['service_name']:
        dialog_context['service_name'] = params['service_name']
```

### Из сообщений пользователя
```python
# Простое извлечение дат
date_patterns = [
    r'\d{1,2}[./]\d{1,2}[./]\d{2,4}',  # 15.01.2024
    r'\d{1,2}\s+(января|февраля|...)',  # 15 января
    r'(сегодня|завтра|послезавтра)',    # относительные даты
]
```

## Преимущества

1. **Стабильность:** LLM больше не "забывает" важные параметры
2. **Контекстность:** Система помнит информацию из предыдущих сообщений
3. **Автоматизация:** Обогащение происходит прозрачно для LLM
4. **Расширяемость:** Легко добавить новые типы сущностей

## Примеры работы

### Сценарий 1: Поэтапная запись
```
Пользователь: "Хочу записаться на маникюр"
→ Сохраняется: service_name = "маникюр"

Пользователь: "На завтра"  
→ Сохраняется: date = "завтра"

LLM: get_available_slots(service_name="", date="")
→ Обогащается: get_available_slots(service_name="маникюр", date="завтра")
```

### Сценарий 2: Повторное использование
```
Пользователь: "А какие мастера есть?"
→ LLM: get_masters_for_service(service_name="")
→ Обогащается: get_masters_for_service(service_name="маникюр")
```

## Логирование
Все операции обогащения логируются:
```
🔍 Сохранен service_name в контекст: маникюр
🔧 Обогащен get_available_slots: добавлен service_name = маникюр
🔧 Параметры одиночного инструмента обогащены: {...}
```
