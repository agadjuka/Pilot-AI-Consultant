# üìã –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è LLM –≤ –Ø–Ω–¥–µ–∫—Å

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–í –≤–∞—à–µ–π –¥–∏–∞–ª–æ–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —Ç—Ä–µ–º—è —Ç–∏–ø–∞–º–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:

1. **–ü–†–û–ú–ü–¢ 1: –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø** - –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
2. **–ü–†–û–ú–ü–¢ 2: –ú–´–®–õ–ï–ù–ò–ï** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
3. **–ü–†–û–ú–ü–¢ 3: –°–ò–ù–¢–ï–ó** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

---

## üîç –ü–†–û–ú–ü–¢ 1: –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø (–≠—Ç–∞–ø 1)

### üìç –ò—Å—Ç–æ—á–Ω–∏–∫
- **–§–∞–π–ª:** `app/services/prompt_builder_service.py`
- **–ú–µ—Ç–æ–¥:** `build_classification_prompt()`
- **–®–∞–±–ª–æ–Ω:** `CLASSIFICATION_TEMPLATE` (—Å—Ç—Ä–æ–∫–∏ 28-51)

### üìù –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```
# –ó–ê–î–ê–ß–ê
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ —Å—Ç–∞–¥–∏—é –ü–û–°–õ–ï–î–ù–ï–ì–û —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –≤—ã–±—Ä–∞–≤ –û–î–ù–£ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.

# –°–ü–ò–°–û–ö –°–¢–ê–î–ò–ô –ò –ò–• –û–ü–ò–°–ê–ù–ò–Ø
- `greeting`: –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è.
- `service_inquiry`: –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —É—Å–ª—É–≥–∞—Ö, –∏—Ö –¥–µ—Ç–∞–ª—è—Ö –∏–ª–∏ —Ü–µ–Ω–∞—Ö.
- `booking_start`: –ö–ª–∏–µ–Ω—Ç –≤—ã—Ä–∞–∑–∏–ª –∂–µ–ª–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–≤–µ—Ç–∏–ª '–¥–∞' –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏), –Ω–æ –µ—â–µ –Ω–µ –Ω–∞–∑–≤–∞–ª –¥–∞—Ç—É.
- `availability_check`: –ö–ª–∏–µ–Ω—Ç –Ω–∞–∑–≤–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (—Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞, –≤ —Å—É–±–±–æ—Ç—É) –∏ —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è.
- `booking_confirmation`: –ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–¥–∞, 15:00 –ø–æ–¥—Ö–æ–¥–∏—Ç').
- `view_booking`: –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏.
- `cancellation_request`: –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å.
- `conflict_escalation`: –ö–ª–∏–µ–Ω—Ç –∂–∞–ª—É–µ—Ç—Å—è –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç –ø–æ–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–í–´–°–®–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢).
- `fallback`: –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –ø–æ–¥ –æ–¥–Ω—É –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

## –ò–°–¢–û–†–ò–Ø
{history}

## –ù–û–í–û–ï –°–û–û–ë–©–ï-–ù–ò–ï
{user_message}

# –û–¢–í–ï–¢
–í –æ—Ç–≤–µ—Ç–µ —É–∫–∞–∂–∏ –¢–û–õ–¨–ö–û ID —Å—Ç–∞–¥–∏–∏.
```

### üîß –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|----------|
| **`{history}`** | `_format_dialog_history()` | –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `<\|user\|>\n—Ç–µ–∫—Å—Ç\n<\|assistant\|>\n–æ—Ç–≤–µ—Ç` |
| **`{user_message}`** | –ü—Ä—è–º–æ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ | –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### üìã –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

```python
def _format_dialog_history(self, history: List[Dict]) -> str:
    if not history:
        return "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞"
    
    formatted_history = []
    for msg in history:
        role_tag = "<|user|>" if msg["role"] == "user" else "<|assistant|>"
        content = msg["parts"][0]["text"]
        formatted_history.append(f"{role_tag}\n{content}")
    
    return "\n".join(formatted_history)
```

---

## üß† –ü–†–û–ú–ü–¢ 2: –ú–´–®–õ–ï–ù–ò–ï (–≠—Ç–∞–ø 2)

### üìç –ò—Å—Ç–æ—á–Ω–∏–∫
- **–§–∞–π–ª:** `app/services/prompt_builder_service.py`
- **–ú–µ—Ç–æ–¥:** `build_thinking_prompt()`
- **–®–∞–±–ª–æ–Ω:** `THINKING_TEMPLATE` (—Å—Ç—Ä–æ–∫–∏ 54-108)

### üìù –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```
# –†–û–õ–¨ –ò –°–¢–ò–õ–¨
–¢—ã ‚Äî –ö—ç—Ç, AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã "–≠–ª–µ–≥–∞–Ω—Ç". –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∑–∞–ø–∏—Å—å—é –Ω–∞ —É—Å–ª—É–≥–∏. –¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: —Ç–µ–ø–ª—ã–π, –Ω–æ –¥–µ–ª–æ–≤–æ–π, —Å –ª–µ–≥–∫–∏–º —é–º–æ—Ä–æ–º –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ. –¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏—à—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∏—Ö –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è.

# –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ª–æ–≥–∏—á–Ω–æ **–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥**.
1. **–ü—Ä–æ–¥–æ–ª–∂–∏ –¥–∏–∞–ª–æ–≥ –ª–æ–≥–∏—á–Ω–æ**, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ –ò–°–¢–û–†–ò–Æ, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è.
2. **–ò—Å–ø–æ–ª—å–∑—É–π –°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï**, —á—Ç–æ–±—ã –¥–∞—Ç—å –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –ü–û–°–õ–ï–î–ù–ò–ô –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê.
3. –ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π "–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´".
4. –ò–Ω–æ–≥–¥–∞ –æ–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏. –ù–µ –¥–µ–ª–∞–π —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
5. –ò–Ω–æ–≥–¥–∞ –≤ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏. –ù–µ –¥–µ–ª–∞–π —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏–∏
6.–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ–±—â–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏, —Å—Ç–∞—Ä–∞–π—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∏—Ö.

**–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:**
1.  **–ù–ï –ó–î–û–†–û–í–ê–ô–°–Ø**, –µ—Å–ª–∏ –≤ –ò–°–¢–û–†–ò–ò —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –ø–æ —Å—É—Ç–∏.
2.  **–ù–ï –û–ë–†–ê–©–ê–ô–°–Ø –ü–û –ò–ú–ï–ù–ò –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.** –î–µ–ª–∞–π —ç—Ç–æ –∏–∑—Ä–µ–¥–∫–∞

# –ö–û–ù–¢–ï–ö–°–¢
- –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_datetime}
- –û –∫–ª–∏–µ–Ω—Ç–µ: {client_context}
- –ò—Å—Ç–æ—Ä–∏—è: {history}
- –ó–∞–ø—Ä–æ—Å: {user_message}
{hidden_context}

# –°–¶–ï–ù–ê–†–ò–ô –î–õ–Ø –°–¢–ê–î–ò–ò '{stage_name}':
{stage_scenario}

# –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê
–°–ª–µ–¥—É—è —Å—Ü–µ–Ω–∞—Ä–∏—é, —Ä–µ—à–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ. –£ —Ç–µ–±—è –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞:
1. **–ï—Å–ª–∏** —Ç–µ–±–µ –ù–ï –•–í–ê–¢–ê–ï–¢ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω—É–∂–Ω—ã —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã), –≤–µ—Ä–Ω–∏ **–¢–û–õ–¨–ö–û JSON** —Å –≤—ã–∑–æ–≤–æ–º "—Ä–∞–∑–≤–µ–¥—ã–≤–∞—Ç–µ–ª—å–Ω—ã—Ö" –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.
2. **–ï—Å–ª–∏** —Ç–µ–±–µ –•–í–ê–¢–ê–ï–¢ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Å—Ç–æ **—Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç** –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

# "–†–ê–ó–í–ï–î–´–í–ê–¢–ï–õ–¨–ù–´–ï" –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
{read_only_tools_summary}

# –†–ê–ë–û–¢–ê –° ID –ó–ê–ü–ò–°–ï–ô
–ï—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è # –°–ö–†–´–¢–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ó–ê–ü–ò–°–ï–ô, —ç—Ç–æ —Ç–≤–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è ID.
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç—Ä–µ–±—É—é—â–∏–π `appointment_id` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cancel_appointment_by_id`), —Ç—ã –û–ë–Ø–ó–ê–ù –≤–∑—è—Ç—å —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `id` –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- –°–æ–ø–æ—Å—Ç–∞–≤—å –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–æ—Ç–º–µ–Ω–∏—Ç–µ —Å—Ç—Ä–∏–∂–∫—É") —Å –ø–æ–ª–µ–º `details` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `id`.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä `appointment_id`.

# –§–û–†–ú–ê–¢ –ó–ê–ü–†–û–°–ê –î–ê–ù–ù–´–•
–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç–æ–º —Å –∫–ª—é—á–æ–º `tool_calls`.
`tool_calls` ‚Äî —ç—Ç–æ –ú–ê–°–°–ò–í –û–ë–™–ï–ö–¢–û–í. –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∫–ª—é—á–∏ `tool_name` –∏ `parameters`.

**–ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢:**
```json
{"tool_calls": [{"tool_name": "get_available_slots", "parameters": {"date": "2025-10-16"}}]}
```

**–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ (–ù–ï –î–ï–õ–ê–ô –¢–ê–ö):**
```json
{"tool_calls": ["get_available_slots"]}
```

–í–ê–ñ–ù–û: `tool_calls` ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ –û–ë–™–ï–ö–¢–û–í, –∞ –Ω–µ —Å—Ç—Ä–æ–∫!
```

### üîß –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|----------|
| **`{current_datetime}`** | `_generate_current_datetime()` | –§–æ—Ä–º–∞—Ç: "–°–µ–≥–æ–¥–Ω—è: –ß–µ—Ç–≤–µ—Ä–≥, 16.10.2025, –≤—Ä–µ–º—è: 11:52" |
| **`{client_context}`** | –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ `build_thinking_prompt()` | "–ò–º—è: –ò–≥–æ—Ä—å, –¢–µ–ª–µ—Ñ–æ–Ω: —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ" |
| **`{history}`** | `_format_dialog_history()` | –ò—Å—Ç–æ—Ä–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `<\|user\|>\n—Ç–µ–∫—Å—Ç\n<\|assistant\|>\n–æ—Ç–≤–µ—Ç` |
| **`{user_message}`** | –ü—Ä—è–º–æ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ | –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **`{hidden_context}`** | –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ `DialogService` | –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å ID –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã/–ø–µ—Ä–µ–Ω–æ—Å–∞ |
| **`{stage_name}`** | –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Å—Ç–∞–¥–∏—è (greeting, service_inquiry, etc.) |
| **`{stage_scenario}`** | `dialogue_patterns.json` + `_format_stage_principles()` | –°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞–¥–∏–∏ |
| **`{read_only_tools_summary}`** | `all_tools_dict` + `_generate_tools_summary()` | –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ |

### üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### 1. `{current_datetime}` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
```python
def _generate_current_datetime(self) -> str:
    now = datetime.now()
    
    # –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
    weekdays = {
        0: "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", 1: "–í—Ç–æ—Ä–Ω–∏–∫", 2: "–°—Ä–µ–¥–∞",
        3: "–ß–µ—Ç–≤–µ—Ä–≥", 4: "–ü—è—Ç–Ω–∏—Ü–∞", 5: "–°—É–±–±–æ—Ç–∞", 6: "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
    }
    
    weekday = weekdays[now.weekday()]
    date_str = now.strftime("%d.%m.%Y")
    time_str = now.strftime("%H:%M")
    
    return f"–°–µ–≥–æ–¥–Ω—è: {weekday}, {date_str}, –≤—Ä–µ–º—è: {time_str}"
```

#### 2. `{client_context}` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞
```python
client_context_parts = []
if client_name:
    client_context_parts.append(f"–ò–º—è: {client_name}")
if client_phone_saved:
    client_context_parts.append("–¢–µ–ª–µ—Ñ–æ–Ω: —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ")

client_context = ", ".join(client_context_parts) if client_context_parts else "–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –∏–∑–≤–µ—Å—Ç–Ω—ã"
```

#### 3. `{stage_scenario}` - —Å—Ü–µ–Ω–∞—Ä–∏–π —Å—Ç–∞–¥–∏–∏ –∏–∑ dialogue_patterns.json

**–î–ª—è —Å—Ç–∞–¥–∏–∏ `greeting`:**
```
1. –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤, –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
2. –ó–∞–¥–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–π, –Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?').
3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è.
```

**–î–ª—è —Å—Ç–∞–¥–∏–∏ `service_inquiry`:**
```
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –æ –∫–∞–∫–æ–π —É—Å–ª—É–≥–µ –∏–¥–µ—Ç —Ä–µ—á—å.
2. –í—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `get_all_services`, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç.
3. –ù–∞–π–¥–∏ –≤ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—É—é —É—Å–ª—É–≥—É. –ï—Å–ª–∏ –µ–µ –Ω–µ—Ç, –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.
4. –ï—Å–ª–∏ —É—Å–ª—É–≥–∞ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–æ–±—â–∏ –∫–ª–∏–µ–Ω—Ç—É –µ–µ —Ü–µ–Ω—É –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
5. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø—Ä–æ—Å–∏, —Ö–æ—á–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?').
6. –í–ê–ñ–ù–û: –ù–ï –≤—ã–∑—ã–≤–∞–π `get_available_slots` –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏.
```

#### 4. `{read_only_tools_summary}` - –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```python
def _generate_tools_summary(self, tools_list: List) -> str:
    tools_summary = ""
    
    for func_decl in tools_list:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å—Ö–µ–º—ã
        params = []
        if hasattr(func_decl, 'parameters') and func_decl.parameters:
            params_dict = func_decl.parameters
            if hasattr(params_dict, 'properties') and params_dict.properties:
                params = list(params_dict.properties.keys())
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        if params:
            params_str = ", ".join(params)
            short_desc = func_decl.description.split('.')[0]
            tools_summary += f"- {func_decl.name}({params_str}): {short_desc}.\n"
        else:
            short_desc = func_decl.description.split('.')[0]
            tools_summary += f"- {func_decl.name}(): {short_desc}.\n"
    
    return tools_summary.strip()
```

**–ü—Ä–∏–º–µ—Ä –¥–ª—è —Å—Ç–∞–¥–∏–∏ `service_inquiry`:**
```
- get_all_services(): –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã.
```

#### 5. `{hidden_context}` - —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–º–µ–Ω—ã/–ø–µ—Ä–µ–Ω–æ—Å–∞
```python
if stage in ['cancellation_request', 'rescheduling'] and 'appointments_in_focus' in session_context:
    appointments_data = session_context['appointments_in_focus']
    if appointments_data:
        hidden_context = f"\n\n## –°–ö–†–´–¢–´–ô –ö–û–ù–¢–ï–ö–°–¢ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è):\n"
        hidden_context += f"–ó–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ —Å ID –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π:\n"
        for appointment in appointments_data:
            hidden_context += f"- ID: {appointment['id']}, {appointment['details']}\n"
        hidden_context += f"\n–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ ID –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ cancel_appointment_by_id –∏–ª–∏ reschedule_appointment_by_id.\n"
```

---

## üéØ –ü–†–û–ú–ü–¢ 3: –°–ò–ù–¢–ï–ó (–≠—Ç–∞–ø 3)

### üìç –ò—Å—Ç–æ—á–Ω–∏–∫
- **–§–∞–π–ª:** `app/services/prompt_builder_service.py`
- **–ú–µ—Ç–æ–¥:** `build_synthesis_prompt()`
- **–®–∞–±–ª–æ–Ω:** `SYNTHESIS_TEMPLATE` (—Å—Ç—Ä–æ–∫–∏ 111-148)

### üìù –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```
# –†–û–õ–¨ –ò –°–¢–ò–õ–¨
–¢—ã ‚Äî –ö—ç—Ç, AI-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã "–≠–ª–µ–≥–∞–Ω—Ç". –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∑–∞–ø–∏—Å—å—é –Ω–∞ —É—Å–ª—É–≥–∏. –¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: —Ç–µ–ø–ª—ã–π, –Ω–æ –¥–µ–ª–æ–≤–æ–π, —Å –ª–µ–≥–∫–∏–º —é–º–æ—Ä–æ–º –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ. –¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏—à—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∏—Ö –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∏–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.

# –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ª–æ–≥–∏—á–Ω–æ **–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥**.
1. **–ü—Ä–æ–¥–æ–ª–∂–∏ –¥–∏–∞–ª–æ–≥ –ª–æ–≥–∏—á–Ω–æ**, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ –ò–°–¢–û–†–ò–Æ, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è.
2. –ò–Ω–æ–≥–¥–∞ (—Ä–∞–∑ –≤ 3-5 —Å–æ–æ–±—â–µ–Ω–∏–π) –æ–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –∏–º–µ–Ω–∏. –ù–µ –¥–µ–ª–∞–π —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
3. **–ò—Å–ø–æ–ª—å–∑—É–π –°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï**, —á—Ç–æ–±—ã –¥–∞—Ç—å –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –ü–û–°–õ–ï–î–ù–ò–ô –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê.
4. –ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π "–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´".
5. –ò–Ω–æ–≥–¥–∞ (–∏–∑—Ä–µ–¥–∫–∞) –≤ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏. –ù–µ –¥–µ–ª–∞–π —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏–∏
6.–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ–±—â–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ–π —Å—Ç–∞–¥–∏–∏, —Å—Ç–∞—Ä–∞–π—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∏—Ö.

**–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:**
1.  **–ù–ï –ó–î–û–†–û–í–ê–ô–°–Ø**, –µ—Å–ª–∏ –≤ –ò–°–¢–û–†–ò–ò —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≥–æ–≤–æ—Ä –ø–æ —Å—É—Ç–∏.

# –ö–û–ù–¢–ï–ö–°–¢
- –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_datetime}
- –û –∫–ª–∏–µ–Ω—Ç–µ: {client_context}
- –ò—Å—Ç–æ—Ä–∏—è: {history}
- –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å: {user_message}
- **–°–æ–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–±–æ–π –¥–∞–Ω–Ω—ã–µ:** {tool_results}

# "–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï" –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
{write_tools_summary}

# –§–û–†–ú–ê–¢ –î–ï–ô–°–¢–í–ò–Ø (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```json
{"tool_calls": [{"tool_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞", "parameters": {"param1": "value1", "param2": "value2"}}]}
```

–í–ê–ñ–ù–û: 
- –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã + –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É ‚Äî –≤–µ—Ä–Ω–∏ JSON, –∞ –∑–∞—Ç–µ–º —Ç–µ–∫—Å—Ç
- –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã ‚Äî –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç

# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢:
```

### üîß –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|----------|
| **`{current_datetime}`** | `_generate_current_datetime()` | –¢–æ –∂–µ, —á—Ç–æ –≤ –ø—Ä–æ–º–ø—Ç–µ –º—ã—à–ª–µ–Ω–∏—è |
| **`{client_context}`** | –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ `build_synthesis_prompt()` | –¢–æ –∂–µ, —á—Ç–æ –≤ –ø—Ä–æ–º–ø—Ç–µ –º—ã—à–ª–µ–Ω–∏—è |
| **`{history}`** | `_format_dialog_history()` | –¢–æ –∂–µ, —á—Ç–æ –≤ –ø—Ä–æ–º–ø—Ç–µ –º—ã—à–ª–µ–Ω–∏—è |
| **`{user_message}`** | –ü—Ä—è–º–æ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ | –¢–æ –∂–µ, —á—Ç–æ –≤ –ø—Ä–æ–º–ø—Ç–µ –º—ã—à–ª–µ–Ω–∏—è |
| **`{tool_results}`** | –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ | –î–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–∞–ø–µ –º—ã—à–ª–µ–Ω–∏—è |
| **`{write_tools_summary}`** | `all_tools_dict` + `_generate_tools_summary()` | –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ |

### üìã –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –ø—Ä–æ–º–ø—Ç–∞ –º—ã—à–ª–µ–Ω–∏—è

#### 1. `{tool_results}` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
```
–†–µ–∑—É–ª—å—Ç–∞—Ç get_all_services: –£—Å–ª—É–≥–∞: –ñ–µ–Ω—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞, –¶–µ–Ω–∞: 2500.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞, –¶–µ–Ω–∞: 1500.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 45 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–π, –¶–µ–Ω–∞: 4000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 120 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ (Airtouch), –¶–µ–Ω–∞: 9000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 240 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –£–∫–ª–∞–¥–∫–∞ –≤–µ—á–µ—Ä–Ω—è—è, –¶–µ–Ω–∞: 3000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 75 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ú–∞–Ω–∏–∫—é—Ä —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –≥–µ–ª—å-–ª–∞–∫, –¶–µ–Ω–∞: 2000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 90 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ü–µ–¥–∏–∫—é—Ä, –¶–µ–Ω–∞: 3000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 75 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –Ω–æ–≥—Ç–µ–π, –¶–µ–Ω–∞: 4500.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 150 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞, –¶–µ–Ω–∞: 3500.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 90 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞, –¶–µ–Ω–∞: 2500.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –±—Ä–æ–≤–µ–π, –¶–µ–Ω–∞: 1000.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 30 –º–∏–Ω.
–£—Å–ª—É–≥–∞: –õ–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü, –¶–µ–Ω–∞: 2800.0 —Ä—É–±., –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 70 –º–∏–Ω.
```

#### 2. `{write_tools_summary}` - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
```
- create_appointment(master_name, service_name, date, time, client_name): –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –∏ —É—Å–ª—É–≥–∏.
- cancel_appointment_by_id(appointment_id): –û—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ –µ—ë –£–ù–ò–ö–ê–õ–¨–ù–û–ú–£ –ß–ò–°–õ–û–í–û–ú–£ ID.
- reschedule_appointment_by_id(appointment_id, new_date, new_time): –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –∑–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ –µ—ë –£–ù–ò–ö–ê–õ–¨–ù–û–ú–£ –ß–ò–°–õ–û–í–û–ú–£ ID.
- call_manager(reason): –í—ã–∑—ã–≤–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
```

---

## üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ 2 –∏ 3

| –ê—Å–ø–µ–∫—Ç | –ü—Ä–æ–º–ø—Ç –ú—ã—à–ª–µ–Ω–∏—è | –ü—Ä–æ–º–ø—Ç –°–∏–Ω—Ç–µ–∑–∞ |
|--------|-----------------|----------------|
| **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** | –¢–æ–ª—å–∫–æ read-only | –¢–æ–ª—å–∫–æ write (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ) |
| **–î–∞–Ω–Ω—ã–µ** | –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ | –ï—Å—Ç—å `{tool_results}` |
| **–ó–∞–¥–∞—á–∞** | –°–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã | –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç |
| **–°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç** | –ï—Å—Ç—å `{hidden_context}` | –ù–µ—Ç |
| **–°—Ü–µ–Ω–∞—Ä–∏–π —Å—Ç–∞–¥–∏–∏** | –ï—Å—Ç—å `{stage_scenario}` | –ù–µ—Ç |
| **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞** | JSON —Å tool_calls –∏–ª–∏ —Ç–µ–∫—Å—Ç | –¢–µ–∫—Å—Ç —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ tool_calls |

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –ª–æ–≥–æ–≤

### –õ–æ–≥ 1 (greeting —Å—Ç–∞–¥–∏—è)
- **–ü—Ä–æ–º–ø—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:** 998 —Å–∏–º–≤–æ–ª–æ–≤
- **–ü—Ä–æ–º–ø—Ç –º—ã—à–ª–µ–Ω–∏—è:** 2895 —Å–∏–º–≤–æ–ª–æ–≤
- **–ü—Ä–æ–º–ø—Ç —Å–∏–Ω—Ç–µ–∑–∞:** –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è (–æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –Ω–∞ —ç—Ç–∞–ø–µ –º—ã—à–ª–µ–Ω–∏—è)

### –õ–æ–≥ 2 (service_inquiry —Å—Ç–∞–¥–∏—è)
- **–ü—Ä–æ–º–ø—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:** 1069 —Å–∏–º–≤–æ–ª–æ–≤
- **–ü—Ä–æ–º–ø—Ç –º—ã—à–ª–µ–Ω–∏—è:** 3311 —Å–∏–º–≤–æ–ª–æ–≤
- **–ü—Ä–æ–º–ø—Ç —Å–∏–Ω—Ç–µ–∑–∞:** 2639 —Å–∏–º–≤–æ–ª–æ–≤ + 847 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

---

## üõ†Ô∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### Read-only –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ —ç—Ç–∞–ø–µ –º—ã—à–ª–µ–Ω–∏—è)

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----------|----------|
| `get_all_services` | - | –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã |
| `get_masters_for_service` | service_name | –ù–∞—Ö–æ–¥–∏—Ç –º–∞—Å—Ç–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É |
| `get_available_slots` | service_name, date | –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ |
| `get_my_appointments` | - | –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `get_full_history` | - | –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ |

### Write –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ —ç—Ç–∞–ø–µ —Å–∏–Ω—Ç–µ–∑–∞)

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|-----------|----------|
| `create_appointment` | master_name, service_name, date, time, client_name | –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ |
| `cancel_appointment_by_id` | appointment_id | –û—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ ID |
| `reschedule_appointment_by_id` | appointment_id, new_date, new_time | –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –∑–∞–ø–∏—Å—å –Ω–∞ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è |
| `call_manager` | reason | –í—ã–∑—ã–≤–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ |

---

## üìÅ –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
- `app/services/prompt_builder_service.py` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- `app/services/dialog_service.py` - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
- `dialogue_patterns.json` - —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Å—Ç–∞–¥–∏–π
- `app/services/tool_definitions.py` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### –õ–æ–≥–∏
- `debug_logs/20251016_115220_user261617302.md` - –ª–æ–≥ greeting —Å—Ç–∞–¥–∏–∏
- `debug_logs/20251016_120127_user261617302.md` - –ª–æ–≥ service_inquiry —Å—Ç–∞–¥–∏–∏

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

1. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞
2. **–ú—ã—à–ª–µ–Ω–∏–µ** - —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ read-only –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
3. **–°–∏–Ω—Ç–µ–∑** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏

–ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç –∏–º–µ–µ—Ç —Å–≤–æ—é —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –∏ –Ω–∞–±–æ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
