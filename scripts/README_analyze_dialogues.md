# AI-Аналитик диалогов

Скрипт для автоматического анализа диалогов салона красоты и генерации структурированных паттернов диалогов.

## Описание

Этот скрипт читает сырые диалоги из папки `source_dialogues/`, анализирует их с помощью Gemini AI, извлекает паттерны диалогов и сохраняет результат в структурированном JSON-файле `dialogue_patterns.json`.

## Возможности

- **Автоматический анализ диалогов**: Использует мощную LLM (Gemini) для извлечения паттернов
- **Классификация по стадиям**: Определяет различные стадии диалога (приветствие, уточнение цены, запись и т.д.)
- **Извлечение принципов**: Выделяет ключевые принципы общения для каждой стадии
- **Сбор примеров**: Сохраняет конкретные примеры реплик "вопрос-ответ"
- **Группировка и дедупликация**: Объединяет похожие паттерны и удаляет дубликаты
- **Асинхронная обработка**: Быстрая обработка множества диалогов

## Структура проекта

```
beauty_salon_ai/
├── scripts/
│   └── analyze_dialogues.py    # Основной скрипт анализа
├── source_dialogues/           # Папка с исходными диалогами
│   ├── example_dialogue_1.txt
│   └── example_dialogue_2.txt
└── dialogue_patterns.json      # Результат анализа (создается автоматически)
```

## Использование

### 1. Подготовка диалогов

Поместите текстовые файлы с диалогами в папку `source_dialogues/`. Каждый файл должен содержать диалог в формате:

```
Клиент: Сообщение клиента
Менеджер: Ответ менеджера
Клиент: Следующее сообщение
...
```

### 2. Запуск анализа

```bash
python scripts/analyze_dialogues.py
```

### 3. Результат

Скрипт создаст файл `dialogue_patterns.json` со структурой:

```json
{
  "greeting": {
    "principles": [
      "Всегда здоровайся в ответ",
      "Задай открытый вопрос"
    ],
    "examples": [
      {
        "user": "привет",
        "assistant": "Добрый день! Чем могу помочь?"
      }
    ]
  },
  "price_inquiry": {
    "principles": [
      "Четко назови цену",
      "Сразу предложи следующий шаг"
    ],
    "examples": [
      {
        "user": "сколько стоит стрижка",
        "assistant": "Стрижка стоит 1500р. Хотите подобрать время?"
      }
    ]
  }
}
```

## Требования

- Python 3.8+
- Google Cloud credentials (настроены в `.env`)
- Установленные зависимости:
  - `google-generativeai`
  - `google-auth`
  - `python-dotenv`

## Настройка

Убедитесь, что в файле `.env` настроены переменные:

```env
GOOGLE_APPLICATION_CREDENTIALS=path/to/your/credentials.json
GCP_PROJECT_ID=your_project_id
```

## Архитектура скрипта

### Класс `DialogueAnalyzer`

Основной класс для анализа диалогов:

- `extract_patterns_from_dialogue()` - извлекает паттерны из одного диалога
- `load_dialogues_from_directory()` - загружает диалоги из папки
- `merge_patterns()` - объединяет паттерны по стадиям
- `analyze_all_dialogues()` - основная логика анализа
- `save_patterns_to_file()` - сохранение результата

### Принципы работы

1. **Загрузка диалогов**: Читает все `.txt` файлы из `source_dialogues/`
2. **Анализ с помощью AI**: Отправляет каждый диалог в Gemini для анализа
3. **Извлечение паттернов**: Получает структурированные паттерны в JSON формате
4. **Группировка**: Объединяет паттерны по стадиям диалога
5. **Дедупликация**: Удаляет повторяющиеся принципы и примеры
6. **Сохранение**: Записывает результат в `dialogue_patterns.json`

## Обработка ошибок

Скрипт устойчив к ошибкам:
- Ошибки парсинга JSON от LLM
- Отсутствующие файлы диалогов
- Проблемы с аутентификацией Google Cloud
- Некорректные форматы диалогов

## Примеры использования

### Анализ новых диалогов

1. Добавьте новые файлы в `source_dialogues/`
2. Запустите скрипт
3. Получите обновленный `dialogue_patterns.json`

### Интеграция с системой

Созданный файл `dialogue_patterns.json` можно использовать для:
- Обучения AI-ассистента
- Создания базы знаний
- Анализа качества диалогов
- Генерации новых примеров общения

## Логирование

Скрипт выводит подробную информацию о процессе:
- Количество загруженных диалогов
- Прогресс анализа каждого диалога
- Количество найденных паттернов
- Статистику по стадиям диалога
