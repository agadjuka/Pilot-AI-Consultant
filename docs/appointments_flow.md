## Поток создания, просмотра, изменения и отмены записей через диалог

Этот документ описывает, как работает оформление записи в салон через диалог с ИИ (Gemini/Яндекс), а также просмотр и отмена записей. Указаны форматы инструментов, куда и какие данные передаются, что возвращается, и как данные оказываются в базе данных и календаре.

### Участники процесса
- **Пользователь**: пишет в чат (Telegram).
- **Вебхук Telegram**: принимает сообщение и передаёт его в диалоговый сервис (`app/api/telegram.py → DialogService`).
- **DialogService**: оркестратор диалога. Сохраняет историю, классифицирует стадию, формирует системный промпт, запускает генерацию и обрабатывает вызовы инструментов (`app/services/dialog_service.py`).
- **LLM (Gemini / Яндекс)**: генерирует ответы и (важно) вызывает инструменты (function calling) для работы с данными.
- **ToolService**: реализация инструментов: поиск услуг/мастеров/слотов, создание/просмотр/отмена записей (`app/services/tool_service.py`).
- **GoogleCalendarService**: работа с календарём — создание/удаление событий и поиск занятости (`app/services/google_calendar_service.py`).
- **Репозитории/Модели БД**: фактическая запись в локальную БД (`app/repositories/*`, `app/models/*`).

### Сквозной поток: от сообщения до записи в БД
1) Пользователь пишет в Telegram. Сообщение попадает в эндпоинт `process_telegram_update` и передаётся в `DialogService.process_user_message`.
2) `DialogService`:
   - сохраняет сообщение в историю диалога,
   - запускает классификацию стадии (например: выбор услуги, подтверждение записи, просмотр записей, отмена и т.п.),
   - формирует системный промпт с правилами и примерами,
   - запускает цикл генерации, где модель может вызывать инструменты.
3) Если LLM решает создать запись, она вызывает инструмент `create_appointment(...)`. Если нужно посмотреть свои записи — `get_my_appointments()`. Если отменить — `cancel_appointment(...)`. Если нужно — запрашивает слоты через `get_available_slots(...)`.
4) `ToolService` в свою очередь:
   - при создании записи — ищет сущности в БД, вычисляет время, создаёт событие в Google Calendar, затем создаёт запись в таблице `appointments`;
   - при просмотре — читает записи пользователя из БД;
   - при отмене — удаляет событие в календаре (если возможно) и удаляет запись из БД.
5) Ответ от инструмента возвращается в LLM, которая формирует финальную фразу для пользователя. `DialogService` сохраняет ответ в историю диалога и отправляет его в Telegram.

### Инструменты и форматы вызова
И инструменты, и их аргументы объявлены для LLM (см. `app/services/tool_definitions.py`). Используются два вида вызовов:
- Нативный function calling (Gemini): модель отдаёт структурированный вызов.
- Текстовый формат (Яндекс и fallback): строка вида
  [TOOL: function_name(arg1="value1", arg2="value2")]

Поддерживаемые инструменты (главные по CRUD):
- create_appointment(master_name, service_name, date, time, client_name)
- get_my_appointments()
- cancel_appointment(appointment_details)
- Дополнительно: get_all_services(), get_masters_for_service(service_name), get_available_slots(service_name, date)

Правила для LLM (вкладываются в системную инструкцию):
- При подтверждении записи пользовательскими словами («да», «запишите», «подходит») — сразу вызывать `create_appointment`.
- Если имя/телефон уже сохранены в БД — не спрашивать их повторно.
- Если не хватает имени и/или телефона — сначала аккуратно уточнить и только после этого создавать запись.

### Создание записи (create)
Когда модель вызывает:
- [TOOL: create_appointment(master_name="Анна", service_name="Маникюр", date="2025-10-15", time="10:00", client_name="Мария")]

Внутри `ToolService.create_appointment` происходит:
- Проверка, сохранены ли у клиента ПДн (имя, телефон). Если нет — возвращается специальная строка: "Требуются данные клиента. Перейди в стадию 'contact_info_request'". Диалог затем переходит к сбору ПДн и повторному вызову инструмента.
- Поиск услуги с учётом неточного совпадения названия; извлечение длительности услуги.
- Поиск мастера с учётом неточного совпадения.
- Построение `start_time` и `end_time` по дате/времени и длительности услуги (московский часовой пояс).
- Вызов `GoogleCalendarService.create_event(...)`. Если календарь недоступен, используется fallback с локальным `event_id`, чтобы не блокировать оформление.
- Сохранение записи в БД через `AppointmentRepository.create(...)` с полями: `user_telegram_id`, `google_event_id`, `master_id`, `service_id`, `start_time`, `end_time`.
- Возврат человеку подтверждения: например, "Отлично! Я записала Мария на Маникюр к мастеру Анна на 2025-10-15 в 10:00." (данные берутся из БД/параметров).

Что пишется в БД (модель `appointments`):
- user_telegram_id — Telegram ID клиента,
- google_event_id — ID события в Google Calendar (или локальный fallback),
- master_id, service_id — связи на выбранных мастера и услугу,
- start_time, end_time — дата и время записи.

### Просмотр записей (read)
Когда модель вызывает:
- [TOOL: get_my_appointments()]

Внутри `ToolService.get_my_appointments` происходит:
- Чтение будущих записей пользователя через `AppointmentRepository.get_future_appointments_by_user(...)`.
- Формирование человекочитаемого списка с датами/временем/услугой/мастером, либо сообщение, что записей нет.
- Этот текст возвращается модели, а далее — пользователю.

Дополнительно, при стадии "просмотр записей" `DialogService` может заранее подтянуть список и передать его модели в качестве контекста, чтобы та сформулировала удобный ответ.

### Отмена записи (delete)
Когда модель вызывает:
- [TOOL: cancel_appointment(appointment_details="маникюр завтра")]

Внутри `ToolService.cancel_appointment` происходит:
- Поиск ближайшей будущей записи пользователя через `AppointmentRepository.get_next_appointment_by_user(...)`.
- Попытка удалить событие в календаре `GoogleCalendarService.delete_event(event_id)` (если не удалось — это логируется, но процесс не блокируется).
- Удаление записи из БД через `AppointmentRepository.delete(appointment)`.
- Возврат подтверждения пользователю: например, "Ваша запись на Маникюр 15 октября в 10:00 к мастеру Анна успешно отменена." либо сообщение об отсутствии записей.

Замечание: на текущий момент инструмент отменяет ближайшую запись. Уточнение по тексту `appointment_details` ещё не используется для выборки конкретной записи — это можно расширить при необходимости.

### Изменение записи (update / перенос)
Сценарий изменения существующей записи сейчас не выделен в отдельный инструмент. Поддерживаются операции календаря на уровне сервиса (`GoogleCalendarService.update_event(...)`), но в диалоге инструмента для переноса/изменения нет. Типовой сценарий сейчас — отменить запись и создать новую.

Возможные варианты развития:
- Добавить инструмент `reschedule_appointment(appointment_details, new_date, new_time)` с логикой поиска нужной записи и обновления события в календаре + БД.
- Либо `update_appointment(appointment_id, new_master, new_service, new_date, new_time)` для явного обновления по ID записи.

### Как Яндекс/Gemini передают команды на создание/отмену
- Gemini может вызывать инструменты нативно (структурированный вызов), `DialogService` обработает их напрямую.
- Яндекс может прислать текст с шаблоном:
  [TOOL: create_appointment(master_name="Анна", service_name="Маникюр", date="2025-10-15", time="10:00", client_name="Мария")]
  [TOOL: get_available_slots(service_name="Маникюр", date="2025-10-15")]
  [TOOL: cancel_appointment(appointment_details="маникюр завтра")]

`DialogService` распознаёт такой шаблон регулярным выражением, извлекает имя инструмента и аргументы и вызывает нужный метод `ToolService`. Ответ инструмента затем возвращается модели (как function_response), чтобы та сгенерировала финальную фразу для пользователя.

### Проверки и защита от ошибок
- Если не найдена услуга/мастер — возвращается дружелюбная подсказка с похожими вариантами (нечёткий поиск).
- Если календарь недоступен — используется локальный `event_id`, чтобы не блокировать оформление.
- Если не хватает ПДн (имя/телефон) — диалог мягко переводится на стадию их сбора.
- При отмене — ошибка удаления в календаре не блокирует удаление записи в БД.

### Куда смотреть в коде (для разработчиков)
- Диалог и вызов инструментов: `app/services/dialog_service.py`
- Инструменты (реализация CRUD): `app/services/tool_service.py`
- Доступные инструменты для LLM: `app/services/tool_definitions.py`
- Календарь: `app/services/google_calendar_service.py`
- Репозитории/модели: `app/repositories/*`, `app/models/*`



