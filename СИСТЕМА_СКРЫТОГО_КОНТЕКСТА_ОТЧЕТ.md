# Система скрытого контекста для передачи ID записей в Яндекс

## Обзор системы

Система скрытого контекста предназначена для автоматической передачи ID записей клиента в промпт для Яндекс LLM, чтобы модель могла правильно вызывать инструменты отмены и переноса записей без необходимости запрашивать у клиента дополнительную информацию.

## Архитектура системы

### 1. Кратковременная память сессий

**Расположение:** `app/services/dialog_service.py`, строки 87-89

```python
# Кратковременная память о контексте сессий для каждого пользователя
# Формат: {user_id: {"appointments_in_focus": [{"id": int, "details": str}, ...], ...}}
self.session_contexts = {}
```

**Структура данных:**
```python
{
    user_id: {
        "appointments_in_focus": [
            {"id": 42, "details": "16 October в 16:30: Маникюр с покрытием гель-лак к мастеру Елизавета"},
            {"id": 43, "details": "17 October в 14:00: Стрижка к мастеру Мария"}
        ]
    }
}
```

### 2. Стадии, требующие скрытого контекста

**Расположение:** `app/services/dialog_service.py`, строки 535-565

Система активируется для следующих стадий:
- `cancellation_request` - запрос на отмену записи
- `rescheduling` - перенос записи
- `view_booking` - просмотр записей

## Логика работы системы

### Этап 1: Определение необходимости загрузки записей

**Расположение:** `app/services/dialog_service.py`, строки 535-565

```python
if stage in ['cancellation_request', 'rescheduling']:
    # Проверяем, есть ли уже данные о записях в сессии
    if 'appointments_in_focus' not in session_context:
        # Загружаем записи через ToolService
        appointments_text = await self.tool_orchestrator.execute_single_tool(
            "get_my_appointments", {}, user_id, dialog_context, tracer
        )
        
        # Получаем структурированные данные из AppointmentService
        appointments_data = self.appointment_service.get_my_appointments(user_id)
        session_context['appointments_in_focus'] = appointments_data
```

### Этап 2: Формирование скрытого контекста

**Расположение:** `app/services/dialog_service.py`, строки 603-611

```python
hidden_context = ""
if stage in ['cancellation_request', 'rescheduling'] and 'appointments_in_focus' in session_context:
    appointments_data = session_context['appointments_in_focus']
    if appointments_data:
        hidden_context = f"\n\n## СКРЫТЫЙ КОНТЕКСТ (только для тебя):\n"
        hidden_context += f"Записи клиента с ID для операций:\n"
        for appointment in appointments_data:
            hidden_context += f"- ID: {appointment['id']}, {appointment['details']}\n"
        hidden_context += f"\nИспользуй эти ID для вызова инструментов cancel_appointment_by_id или reschedule_appointment_by_id.\n"
```

### Этап 3: Интеграция в промпт

**Расположение:** `app/services/prompt_builder_service.py`, строки 85, 202-203, 258

Скрытый контекст передается в промпт через параметр `hidden_context`:

```python
def build_thinking_prompt(
    self,
    stage_name: str,
    history: List[Dict],
    user_message: str,
    client_name: Optional[str] = None,
    client_phone_saved: bool = False,
    hidden_context: str = ""  # <-- Здесь передается скрытый контекст
) -> str:
```

**Шаблон промпта:**
```
# КОНТЕКСТ
- Текущая дата: {current_datetime}
- О клиенте: {client_context}
- История: {history}
- Запрос: {user_message}
{hidden_context}  # <-- Здесь вставляется скрытый контекст

# СЦЕНАРИЙ ДЛЯ СТАДИИ '{stage_name}':
{stage_scenario}
```

### Этап 4: Инструкции для LLM

**Расположение:** `app/services/prompt_builder_service.py`, строки 116-121

В промпте есть специальные инструкции для работы с ID записей:

```
# РАБОТА С ID ЗАПИСЕЙ
Если в диалоге появляется # СКРЫТЫЙ КОНТЕКСТ ЗАПИСЕЙ, это твой источник правды для ID.
- Когда нужно вызвать инструмент, требующий `appointment_id` (например, `cancel_appointment_by_id`), ты ОБЯЗАН взять числовое значение `id` из этого контекста.
- Сопоставь запрос клиента (например, "отмените стрижку") с полем `details` в контексте, чтобы найти правильный `id`.
- НИКОГДА не подставляй текстовое описание в параметр `appointment_id`.
```

## Инструменты для работы с записями

### 1. Отмена записи по ID

**Расположение:** `app/services/tool_definitions.py`, строки 143-159

```python
cancel_appointment_by_id_declaration = FunctionDeclaration(
    name="cancel_appointment_by_id",
    description="Отменяет запись по её УНИКАЛЬНОМУ ЧИСЛОВОМУ ID. Параметр `appointment_id` должен быть только типом integer. НЕ передавай в него текст или описание.",
    parameters={
        "type": "object",
        "properties": {
            "appointment_id": {
                "type": "integer",
                "description": "Уникальный числовой ID записи для отмены"
            }
        },
        "required": ["appointment_id"]
    }
)
```

### 2. Перенос записи по ID

**Расположение:** `app/services/tool_definitions.py`, строки 163-179

```python
reschedule_appointment_by_id_declaration = FunctionDeclaration(
    name="reschedule_appointment_by_id",
    description="Переносит запись на новую дату и время по её УНИКАЛЬНОМУ ЧИСЛОВОМУ ID. Параметр `appointment_id` должен быть только типом integer. НЕ передавай в него текст или описание.",
    parameters={
        "type": "object",
        "properties": {
            "appointment_id": {
                "type": "integer",
                "description": "Уникальный числовой ID записи для переноса"
            },
            "new_date": {
                "type": "string",
                "description": "Новая дата в формате YYYY-MM-DD"
            },
            "new_time": {
                "type": "string",
                "description": "Новое время в формате HH:MM"
            }
        },
        "required": ["appointment_id", "new_date", "new_time"]
    }
)
```

## Специальная обработка пустых результатов

**Расположение:** `app/services/dialog_service.py`, строки 834-841

```python
# Специальная обработка для стадии view_booking с пустым результатом
if stage == 'view_booking':
    if 'appointments_in_focus' in session_context:
        appointments_data = session_context['appointments_in_focus']
        if not appointments_data:  # Пустой список означает "нет записей"
            bot_response_text = "У вас нет предстоящих записей."
```

## Преимущества системы

1. **Автоматизация:** Не требует от клиента указания ID записей
2. **Точность:** Исключает ошибки в идентификации записей
3. **Удобство:** Клиент может просто сказать "отмените стрижку" или "перенесите маникюр"
4. **Контекстность:** Система помнит записи в рамках сессии диалога

## Ограничения системы

1. **Кратковременная память:** Данные сохраняются только в рамках сессии
2. **Зависимость от стадий:** Работает только для определенных стадий диалога
3. **Ограниченный объем:** Память не очищается автоматически при смене темы

## Пример работы

1. **Клиент:** "Покажите мои записи"
2. **Система:** Загружает записи в `appointments_in_focus`
3. **Клиент:** "Отмените стрижку"
4. **Система:** Определяет стадию `cancellation_request`
5. **Система:** Формирует скрытый контекст с ID записей
6. **LLM:** Получает контекст и правильно вызывает `cancel_appointment_by_id` с нужным ID
7. **Результат:** Запись отменена без дополнительных вопросов к клиенту

## Техническая реализация

- **Хранение:** В памяти `DialogService.session_contexts`
- **Формат:** JSON-структура с ID и описаниями записей
- **Передача:** Через параметр `hidden_context` в промпт
- **Инструкции:** Встроены в шаблон промпта для LLM
- **Инструменты:** Специальные функции для работы с ID записей
