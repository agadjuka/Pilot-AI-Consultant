# üìä –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –∑–∞–ø–∏—Å–∏ –≤ —Å–∏—Å—Ç–µ–º–µ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**–í–∞–∂–Ω–æ:** –°–∏—Å—Ç–µ–º–∞ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google Calendar**, –∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `DBCalendarService`.

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø–∏—Å–∏

–ò–∑ –∞–Ω–∞–ª–∏–∑–∞ `dialogue_patterns.json` –∏ –∫–æ–¥–∞ —Å–∏—Å—Ç–µ–º—ã –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:

### 1. **availability_check** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
### 2. **booking_start** - –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–ø–∏—Å–∏  
### 3. **booking_confirmation** - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
### 4. **view_booking** - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π
### 5. **cancellation_request** - –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
### 6. **rescheduling** - –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏

---

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã

### 1. üïê **availability_check** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤

**–¶–µ–ª—å:** –ü–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É –Ω–∞–π—Ç–∏ –∏ –≤—ã–±—Ä–∞—Ç—å —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `availability_check`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_available_slots(service_name: str, date: str)`

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 1.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:792-795`)
```python
elif function_name == "get_available_slots":
    service_name = function_args.get("service_name", "")
    date = function_args.get("date", "")
    return method(service_name, date)
```

#### 1.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:99-171`)
```python
def get_available_slots(self, service_name: str, date: str) -> str:
    # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
    parsed_date = parse_date_robust(date)
    
    # –ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏
    all_services = self.service_repository.get_all()
    service = self._find_service_by_fuzzy_match(service_name, all_services)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤
    masters = self.master_repository.get_masters_for_service(service['id'])
    master_names = [m['name'] for m in masters]
    
    # –í—ã–∑–æ–≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    free_intervals = self.db_calendar_service.get_free_slots(
        parsed_date, duration_minutes, master_names=master_names
    )
```

#### 1.3 –†–∞—Å—á–µ—Ç —Å–ª–æ—Ç–æ–≤ –≤ DBCalendarService (`db_calendar_service.py:149-317`)

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:** 10:00 - 20:00
2. **–ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ –∏–º–µ–Ω–∞–º:** 
   ```python
   # ‚ùå –ú–ï–°–¢–û –û–®–ò–ë–ö–ò - —Å—Ç—Ä–æ–∫–∞ 188
   master = next((m for m in all_masters if master_name.lower() in m['name'].lower()), None)
   ```
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–Ω—è—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π:** `_get_appointments_for_masters_on_date()`
4. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–π–º–ª–∞–π–Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏:** —Å–æ–±—ã—Ç–∏—è –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ –∑–∞–ø–∏—Å–µ–π
5. **–ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:** –≥–¥–µ `–∑–∞–Ω—è—Ç–æ—Å—Ç—å < –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–º–∞—Å—Ç–µ—Ä–æ–≤`
6. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã >= `duration_minutes`

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:**
```python
# –°—Ç—Ä–æ–∏–º —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
timeline: List[tuple[datetime, int]] = []
for b in occupied_blocks:
    timeline.append((s, +1))  # –Ω–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
    timeline.append((e, -1))  # –∫–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ç–∞–π–º–ª–∞–π–Ω—É, —Å–æ–±–∏—Ä–∞—è –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≥–¥–µ –∑–∞–Ω—è—Ç–æ—Å—Ç—å < capacity
for t, delta in timeline:
    if busy_count < capacity:  # –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—Å—Ç–µ—Ä–∞
        # –≠—Ç–æ —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç
```

**–£—á–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:**
- –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è = `—Ç–µ–∫—É—â–µ–µ_–≤—Ä–µ–º—è + 1_—á–∞—Å`
- –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø–æ–ª—É—á–∞—Å–∞

**‚ùå –ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ `'int' object has no attribute 'lower'` –≤ `master_repository.py` - –ø–æ–ª–µ `name` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ `bytes`, –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å `.lower()`.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `"10:00-12:00, 14:00-16:00"`

---

### 2. üöÄ **booking_start** - –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–ø–∏—Å–∏

**–¶–µ–ª—å:** –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–∏—Å–∏, —É—Ç–æ—á–Ω–∏–≤ —É –∫–ª–∏–µ–Ω—Ç–∞ –∂–µ–ª–∞–µ–º—É—é –¥–∞—Ç—É.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `booking_start`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_all_services()`

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 2.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:785-786`)
```python
elif function_name == "get_all_services":
    return method()
```

#### 2.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:69-98`)
```python
def get_masters_for_service(self, service_name: str) -> str:
    # –ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏
    all_services = self.service_repository.get_all()
    service = self._find_service_by_fuzzy_match(service_name, all_services)
    
    # –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤
    masters = self.master_repository.get_masters_for_service(service['id'])
    master_names = [master['name'] for master in masters]
    
    return f"–≠—Ç—É —É—Å–ª—É–≥—É –≤—ã–ø–æ–ª–Ω—è—é—Ç –º–∞—Å—Ç–µ—Ä–∞: {', '.join(master_names)}."
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è —É—Å–ª—É–≥–∏

---

### 3. ‚úÖ **booking_confirmation** - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏

**–¶–µ–ª—å:** –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å, –∫–æ–≥–¥–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `booking_confirmation`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `create_appointment(master_name: str, service_name: str, date: str, time: str, client_name: str)`
- `save_client_name(name: str)`
- `save_client_phone(phone: str)`

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 3.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:797-803`)
```python
elif function_name == "create_appointment":
    master_name = function_args.get("master_name", "")
    service_name = function_args.get("service_name", "")
    date = function_args.get("date", "")
    time = function_args.get("time", "")
    client_name = function_args.get("client_name", "")
    return method(master_name, service_name, date, time, client_name, user_id)
```

#### 3.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:173-200`)
```python
def create_appointment(self, master_name: str, service_name: str, date: str, time: str, client_name: str, user_telegram_id: int) -> str:
    # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
    parsed_date = parse_date_robust(date)
    
    # –í—ã–∑–æ–≤ AppointmentService
    return self.appointment_service.create_appointment(
        master_name=master_name,
        service_name=service_name,
        date=parsed_date,
        time=time,
        client_name=client_name,
        user_telegram_id=user_telegram_id
    )
```

#### 3.3 –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ AppointmentService (`appointment_service.py:45-169`)

**–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–∑–¥–∞–Ω–∏—è:**

1. **–ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–∞:** `master_repository.get_by_name(master_name)`
2. **–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:** `service_repository.get_by_name(service_name)`
3. **–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞:** `client_repository.get_by_telegram_id(user_telegram_id)`
4. **–ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏:** `datetime.strptime(time, "%H:%M")`
5. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** `start_datetime + timedelta(minutes=duration_minutes)`
6. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.create_event()`

**–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ DBCalendarService (`db_calendar_service.py:38-85`):**
```python
def create_event(self, master_id: int, service_id: int, user_telegram_id: int, start_time: datetime, end_time: datetime, description: str) -> int:
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    appointment_data = {
        'master_id': master_id,
        'service_id': service_id,
        'user_telegram_id': user_telegram_id,
        'start_time': start_time_iso,
        'end_time': end_time_iso,
        'description': description
    }
    
    appointment_id = self.appointment_repository.create(appointment_data)
    return appointment_id
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –æ—à–∏–±–∫–∞

---

### 4. üëÄ **view_booking** - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π

**–¶–µ–ª—å:** –ü–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –µ–≥–æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `view_booking`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()`

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 4.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:805-806`)
```python
elif function_name == "get_my_appointments":
    return method(user_id)
```

#### 4.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:224-241`)
```python
def get_my_appointments(self, user_telegram_id: int) -> str:
    appointments = self.appointment_service.get_my_appointments(user_telegram_id=user_telegram_id)
    if not appointments:
        return "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π."
    
    result = "–í–∞—à–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏:\n"
    for appointment in appointments:
        result += f"- {appointment['details']}\n"
    return result
```

#### 4.3 –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ AppointmentService (`appointment_service.py:171-225`)

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–ª—É—á–µ–Ω–∏—è:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π:** `appointment_repository.get_future_appointments_by_user(user_telegram_id)`
2. **–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏:**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞: `master_repository.get_by_id(appointment['master_id'])`
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Å–ª—É–≥–∏: `service_repository.get_by_id(appointment['service_id'])`
   - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏: `start_time.strftime("%d %B")`
   - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π: `"{date_str} –≤ {time_str}: {service_name} –∫ –º–∞—Å—Ç–µ—Ä—É {master_name}"`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
```
–í–∞—à–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏:
- 20 –æ–∫—Ç—è–±—Ä—è –≤ 14:00: –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –ê–Ω–Ω–∞
- 22 –æ–∫—Ç—è–±—Ä—è –≤ 10:00: –ú–∞–Ω–∏–∫—é—Ä –∫ –º–∞—Å—Ç–µ—Ä—É –ú–∞—Ä–∏—è
```

---

### 5. üóëÔ∏è **cancellation_request** - –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏

**–¶–µ–ª—å:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—Å—å–±—É –æ–± –æ—Ç–º–µ–Ω–µ, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞—á–∞–≤ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∞.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `cancellation_request`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()` (thinking)
- `cancel_appointment_by_id(appointment_id: int)` (synthesis)

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 5.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:808-816`)
```python
elif function_name == "cancel_appointment_by_id":
    appointment_id = function_args.get("appointment_id") or function_args.get("id", 0)
    try:
        appointment_id = int(appointment_id)
    except (ValueError, TypeError):
        return "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∑–∞–ø–∏—Å–∏"
    return method(appointment_id, user_id)
```

#### 5.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:243-254`)
```python
def cancel_appointment_by_id(self, appointment_id: int, user_telegram_id: int) -> str:
    return self.appointment_service.cancel_appointment_by_id(
        appointment_id=appointment_id, 
        user_telegram_id=user_telegram_id
    )
```

#### 5.3 –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –≤ AppointmentService (`appointment_service.py:227-281`)

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ç–º–µ–Ω—ã:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:** `appointment['user_telegram_id'] != user_telegram_id`
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏:**
   - –ú–∞—Å—Ç–µ—Ä: `master_repository.get_by_id(appointment['master_id'])`
   - –£—Å–ª—É–≥–∞: `service_repository.get_by_id(appointment['service_id'])`
3. **–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.delete_event(appointment_id)`

**–£–¥–∞–ª–µ–Ω–∏–µ –≤ DBCalendarService (`db_calendar_service.py:86-109`):**
```python
def delete_event(self, appointment_id: int) -> None:
    # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    deleted = self.appointment_repository.delete_by_id(appointment_id)
    
    if not deleted:
        raise Exception(f"–ó–∞–ø–∏—Å—å —Å ID {appointment_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏

---

### 6. üìÖ **rescheduling** - –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏

**–¶–µ–ª—å:** –ü–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å.

**–°—Ç–∞–¥–∏—è –¥–∏–∞–ª–æ–≥–∞:** `rescheduling`

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `get_my_appointments()` (thinking)
- `get_available_slots(service_name: str, date: str)` (thinking)
- `reschedule_appointment_by_id(appointment_id: int, new_date: str, new_time: str)` (synthesis)

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**

#### 6.1 –ò–Ω–∏—Ü–∏–∞—Ü–∏—è (`tool_orchestrator_service.py:818-825`)
```python
elif function_name == "reschedule_appointment_by_id":
    appointment_id = function_args.get("appointment_id", 0)
    new_date = function_args.get("new_date", "")
    new_time = function_args.get("new_time", "")
    return method(appointment_id, new_date, new_time, user_id)
```

#### 6.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ ToolService (`tool_service.py:256-275`)
```python
def reschedule_appointment_by_id(self, appointment_id: int, new_date: str, new_time: str, user_telegram_id: int) -> str:
    # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã
    parsed_date = parse_date_robust(new_date)
    
    return self.appointment_service.reschedule_appointment_by_id(
        appointment_id=appointment_id,
        new_date=parsed_date,
        new_time=new_time,
        user_telegram_id=user_telegram_id
    )
```

#### 6.3 –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏ –≤ AppointmentService (`appointment_service.py:283-375`)

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–Ω–æ—Å–∞:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:** `appointment['user_telegram_id'] != user_telegram_id`
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø–∏—Å–∏:**
   - –ú–∞—Å—Ç–µ—Ä: `master_repository.get_by_id(appointment['master_id'])`
   - –£—Å–ª—É–≥–∞: `service_repository.get_by_id(appointment['service_id'])`
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥–∏:** `service['duration_minutes']`
4. **–ü–∞—Ä—Å–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:** `datetime.strptime(new_time, "%H:%M")`
5. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** `start_datetime + timedelta(minutes=duration_minutes)`
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏:** `db_calendar_service.update_event()`

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ DBCalendarService (`db_calendar_service.py:111-145`):**
```python
def update_event(self, appointment_id: int, new_start_time: datetime, new_end_time: datetime) -> None:
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    update_data = {
        'start_time': new_start_time_iso,
        'end_time': new_end_time_iso
    }
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    self.appointment_repository.update(appointment_id, update_data)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–∏

---

## üîß –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### ‚ùå **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**
–û—à–∏–±–∫–∞ `'int' object has no attribute 'lower'` –≤ `master_repository.py` - –ø–æ–ª–µ `name` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ `bytes`, –Ω–æ –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å `.lower()`.

### ‚úÖ **–†–µ—à–µ–Ω–∏–µ**
–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `master_repository._row_to_dict()`:

```python
def _row_to_dict(self, row: tuple) -> Dict[str, Any]:
    return {
        'id': row[0],
        'name': row[1].decode('utf-8') if isinstance(row[1], bytes) else str(row[1]),  # ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        'specialization': row[2]
    }
```

### üîÑ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã**

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**
1. `tool_orchestrator_service` ‚Üí `tool_service` ‚Üí `appointment_service` ‚Üí `db_calendar_service` ‚Üí `repositories` ‚Üí `database`

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:**
- **Read-only tools:** `get_all_services`, `get_masters_for_service`, `get_available_slots`, `get_my_appointments`
- **Write tools:** `create_appointment`, `cancel_appointment_by_id`, `reschedule_appointment_by_id`

**–°—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞:**
- **Thinking stage:** –í—ã–∑–æ–≤ read-only –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- **Synthesis stage:** –í—ã–∑–æ–≤ write –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### üìä **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**

**–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥:**
- `service_name`: "–º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞"
- `date`: "2025-10-20" 
- `time`: "14:00"
- `master_name`: "–ê–Ω–Ω–∞"
- `client_name`: "–ú–∞—Ä–∏—è"
- `appointment_id`: 123

**–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `service`: `{'id': 1, 'name': '–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞', 'duration_minutes': 60, ...}`
- `master`: `{'id': 1, 'name': '–ê–Ω–Ω–∞', 'specialization': '–ú–∞—Å—Å–∞–∂'}`
- `appointment`: `{'id': 123, 'master_id': 1, 'service_id': 1, 'start_time': '2025-10-20T14:00:00', ...}`

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **–°–ª–æ—Ç—ã:** `"10:00-12:00, 14:00-16:00"`
- **–ó–∞–ø–∏—Å–∏:** `"20 –æ–∫—Ç—è–±—Ä—è –≤ 14:00: –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –ê–Ω–Ω–∞"`
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:** `"–û—Ç–ª–∏—á–Ω–æ! –Ø –∑–∞–ø–∏—Å–∞–ª–∞ –ú–∞—Ä–∏—è –Ω–∞ –ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –ê–Ω–Ω–∞ –Ω–∞ 2025-10-20 –≤ 14:00."`

---

## üéØ **–í—ã–≤–æ–¥—ã**

1. **–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google Calendar
2. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è** - thinking (—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö) + synthesis (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
3. **–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã** –∏ –∏—Ö —Ü–∏–∫–ª—ã —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Å–ª–µ–∂–µ–Ω—ã
4. **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞** - –æ—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `master_repository.py`
5. **–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ** –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:**
- `tool_orchestrator_service` ‚Üí `tool_service` ‚Üí `appointment_service` ‚Üí `db_calendar_service` ‚Üí `repositories` ‚Üí `database`
