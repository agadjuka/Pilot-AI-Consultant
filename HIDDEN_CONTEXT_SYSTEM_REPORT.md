# –û—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ DialogService

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ `DialogService` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ ID –∑–∞–ø–∏—Å–µ–π –≤ –ø—Ä–æ–º–ø—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è LLM, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –º–æ–≥–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–º–µ–Ω—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–µ–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1. –ö—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —Å–µ—Å—Å–∏–π

```python
# –í DialogService.__init__()
self.session_contexts = {}
```

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
```python
{
    user_id: {
        "appointments_in_focus": [
            {"id": 42, "details": "16 October –≤ 16:30: –ú–∞–Ω–∏–∫—é—Ä —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –≥–µ–ª—å-–ª–∞–∫ –∫ –º–∞—Å—Ç–µ—Ä—É –ï–ª–∏–∑–∞–≤–µ—Ç–∞"},
            {"id": 43, "details": "17 October –≤ 14:00: –°—Ç—Ä–∏–∂–∫–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –ú–∞—Ä–∏—è"}
        ]
    }
}
```

### 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–π –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
def _determine_stage(self, user_message: str, tool_calls: List[Dict]) -> str:
    # –û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
    if any(word in message_lower for word in ['–æ—Ç–º–µ–Ω–∏—Ç—å', '–æ—Ç–º–µ–Ω–∞', '–æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å', '–æ—Ç–º–µ–Ω–∏—Ç—Ç–µ', '–æ—Ç–º–µ–Ω–∏—Ç–µ']):
        return 'appointment_cancellation'
```

**–°—Ç–∞–¥–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
- `appointment_cancellation` - –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏
- `rescheduling` - –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–ø–∏—Å–∏  
- `cancellation_request` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è LLM)

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –≠—Ç–∞–ø 1: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 1.1 –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π

```python
# –í process_user_message()
current_stage = self._determine_stage(text, [])
logger.info(f"üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ç–∞–¥–∏—è: {current_stage}")
logger.info(f"üîç –ü–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏: {session_context}")

if current_stage in ['appointment_cancellation', 'rescheduling', 'cancellation_request']:
    # –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏, –ø–æ–ª—É—á–∞–µ–º –∏—Ö
    if 'appointments_in_focus' not in session_context:
        appointments_data = self.appointment_service.get_my_appointments(user_id)
        session_context['appointments_in_focus'] = appointments_data
        logger.info(f"üîç –ó–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å: {appointments_data}")
        tracer.add_event("üîç –ó–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å", {
            "appointments_count": len(appointments_data),
            "appointments": appointments_data
        })
```

#### 1.2 –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
appointments_data = session_context.get('appointments_in_focus', [])
if appointments_data:
    hidden_context = "# –°–ö–†–´–¢–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ó–ê–ü–ò–°–ï–ô (–ò–°–ü–û–õ–¨–ó–£–ô –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID):\n" + json.dumps(appointments_data, ensure_ascii=False)
    tracer.add_event("üîç –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è", {
        "stage": current_stage,
        "appointments_count": len(appointments_data),
        "context": hidden_context
    })
```

#### 1.3 –ü–µ—Ä–µ–¥–∞—á–∞ –≤ –ø—Ä–æ–º–ø—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```python
planning_prompt = self.prompt_builder.build_planning_prompt(
    history=dialog_history,
    user_message=text,
    hidden_context=hidden_context
)
```

### –≠—Ç–∞–ø 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

#### 2.1 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ get_my_appointments

```python
# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø–∞–º—è—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ get_my_appointments
if tool_name == 'get_my_appointments':
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ AppointmentService
    appointments_data = self.appointment_service.get_my_appointments(user_id)
    session_context['appointments_in_focus'] = appointments_data
    logger.info(f"üîç –ó–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å: {appointments_data}")
    tracer.add_event("üîç –ó–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å", {
        "appointments_count": len(appointments_data),
        "appointments": appointments_data
    })
```

### –≠—Ç–∞–ø 3: –°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞

#### 3.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ "–ø–∞–º—è—Ç–∏" –∑–∞–ø–∏—Å–∏ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ –ª–∏ —Å—Ç–∞–¥–∏—è
if stage in ['appointment_cancellation', 'rescheduling', 'cancellation_request'] and 'appointments_in_focus' in session_context:
    appointments_context = session_context['appointments_in_focus']
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM
    context_str = "–ö–û–ù–¢–ï–ö–°–¢ –ó–ê–ü–ò–°–ï–ô (–î–õ–Ø –¢–ï–ë–Ø, –ù–ï –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê): " + json.dumps(appointments_context, ensure_ascii=False)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    tool_results += "\n" + context_str
    
    tracer.add_event("üîç –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω", {
        "stage": stage,
        "appointments_count": len(appointments_context),
        "context": context_str
    })
```

### –≠—Ç–∞–ø 4: –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏

#### 4.1 –õ–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏

```python
# –õ–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏: –æ—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –æ –∑–∞–ø–∏—Å—è—Ö, –µ—Å–ª–∏ —Å–º–µ–Ω–∏–ª–∏ —Ç–µ–º—É
if stage not in ['appointment_cancellation', 'rescheduling', 'view_booking', 'cancellation_request']:
    if 'appointments_in_focus' in session_context:
        del session_context['appointments_in_focus']  # –û—á–∏—â–∞–µ–º, –µ—Å–ª–∏ —Å–º–µ–Ω–∏–ª–∏ —Ç–µ–º—É
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö AppointmentService

### get_my_appointments() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```python
def get_my_appointments(self, user_telegram_id: int) -> list:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ.
    
    Returns:
        –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∑–∞–ø–∏—Å—è–º–∏, –≥–¥–µ –∫–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç 'id' –∏ 'details'
    """
    result = []
    for appointment in appointments:
        date_str = appointment.start_time.strftime("%d %B")
        time_str = appointment.start_time.strftime("%H:%M")
        master_name = appointment.master.name
        service_name = appointment.service.name
        
        details = f"{date_str} –≤ {time_str}: {service_name} –∫ –º–∞—Å—Ç–µ—Ä—É {master_name}"
        
        result.append({
            "id": appointment.id,
            "details": details
        })
    
    return result
```

## –®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### PromptBuilderService.planning_template

```python
self.planning_template = """
# –ó–ê–î–ê–ß–ê
–¢—ã ‚Äî —É–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ò–°–¢–û–†–ò–ò –î–ò–ê–õ–û–ì–ê.

# –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (–ß—Ç–æ —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å)
{tools_summary}

{hidden_context}

# –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê
{history}

# –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê
{user_message}
"""
```

**–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `{hidden_context}`** —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞.

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –ü—Ä–∏–º–µ—Ä 1: –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–æ—Ç–º–µ–Ω–∏—Ç–µ –∑–∞–ø–∏—Å—å"
- –°—Ç–∞–¥–∏—è: `appointment_cancellation`
- –ó–∞–ø–∏—Å–∏ –≤ –ø–∞–º—è—Ç–∏: `[{"id": 42, "details": "16 October –≤ 16:30: –ú–∞–Ω–∏–∫—é—Ä –∫ –º–∞—Å—Ç–µ—Ä—É –ï–ª–∏–∑–∞–≤–µ—Ç–∞"}]`

**–°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
```
# –°–ö–†–´–¢–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ó–ê–ü–ò–°–ï–ô (–ò–°–ü–û–õ–¨–ó–£–ô –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø ID):
[{"id": 42, "details": "16 October –≤ 16:30: –ú–∞–Ω–∏–∫—é—Ä –∫ –º–∞—Å—Ç–µ—Ä—É –ï–ª–∏–∑–∞–≤–µ—Ç–∞"}]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç LLM:**
```json
{
  "stage": "cancellation_request",
  "tool_calls": [
    {
      "tool_name": "cancel_appointment_by_id",
      "parameters": {
        "user_telegram_id": 261617302,
        "appointment_id": 42
      }
    }
  ]
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≥–æ–≤–æ—Ä–∏—Ç "–æ—Ç–º–µ–Ω–∏—Ç–µ", –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–∏—Å–µ–π.

**–õ–æ–≥–∏–∫–∞:**
1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å—Ç–∞–¥–∏—è `appointment_cancellation`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏ - –ø—É—Å—Ç–∞—è
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `get_my_appointments(user_id)`
4. –ó–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å
5. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
6. LLM –ø–æ–ª—É—á–∞–µ—Ç ID –∑–∞–ø–∏—Å–µ–π –∏ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

## –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏

### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏:**
   ```
   üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ç–∞–¥–∏—è: appointment_cancellation
   ```

2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏:**
   ```
   üîç –ü–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏: {'appointments_in_focus': [{'id': 42, 'details': '...'}]}
   ```

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π:**
   ```
   üîç –ó–∞–ø–∏—Å–∏ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å: [{'id': 42, 'details': '...'}]
   ```

4. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**
   ```
   üîç –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {"stage": "appointment_cancellation", "appointments_count": 1, "context": "# –°–ö–†–´–¢–´–ô –ö–û–ù–¢–ï–ö–°–¢..."}
   ```

## –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –°—Ç–∞–¥–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ fallback
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã "–æ—Ç–º–µ–Ω–∏—Ç—Ç–µ", "–æ—Ç–º–µ–Ω–∏—Ç–µ"

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ó–∞–ø–∏—Å–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å
**–ü—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ get_my_appointments
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Å—Ç–∞–¥–∏–∏ –æ—Ç–º–µ–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 3: LLM –Ω–µ –≤–∏–¥–∏—Ç ID –∑–∞–ø–∏—Å–µ–π
**–ü—Ä–∏—á–∏–Ω–∞:** –°–∫—Ä—ã—Ç—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `{hidden_context}` –≤ —à–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞

## –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `app/services/dialog_service.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `app/services/prompt_builder_service.py` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- `app/services/appointment_service.py` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `app/services/tool_service.py` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- `DialogService.process_user_message()` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `DialogService._determine_stage()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏
- `AppointmentService.get_my_appointments()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `PromptBuilderService.build_planning_prompt()` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Å–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É ID –∑–∞–ø–∏—Å–µ–π –≤ –ø—Ä–æ–º–ø—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è LLM, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–º–µ–Ω—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–ø–∏—Å–µ–π. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ö—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã –¥–∏–∞–ª–æ–≥–∞
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç–∞–¥–∏–π –æ—Ç–º–µ–Ω—ã/–ø–µ—Ä–µ–Ω–æ—Å–∞
